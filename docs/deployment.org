#+TITLE: Revit Ballet - Deployment Architecture
#+AUTHOR: Revit Ballet
#+DATE: 2026-01-27

* Overview

Revit Ballet development uses a hybrid Windows/Linux environment:
- Revit runs on Windows host
- Claude Code instances run in Hyper-V Debian VMs
- Shared folders enable live development and testing

* Shared Folders via SMB

** Windows Host Setup

Create SMB shares for Revit Addins and runtime data:

#+BEGIN_SRC powershell
# Create SMB user
New-LocalUser -Name "smb-revit-ballet" -NoPassword

# Share runtime folder
New-SmbShare -Name "revit-ballet-runtime" `
  -Path "C:\Users\User\AppData\Roaming\revit-ballet" `
  -FullAccess "smb-revit-ballet"

# Share Revit Addins folder
New-SmbShare -Name "revit-addins" `
  -Path "C:\Users\User\AppData\Roaming\Autodesk\Revit\Addins" `
  -FullAccess "smb-revit-ballet"

# Grant filesystem permissions
icacls "C:\Users\User\AppData\Roaming\revit-ballet" /grant "smb-revit-ballet:(OI)(CI)F" /T
icacls "C:\Users\User\AppData\Roaming\Autodesk\Revit\Addins" /grant "smb-revit-ballet:(OI)(CI)F" /T
#+END_SRC

** Debian VM Setup

Mount shares in =/etc/fstab= with =mfsymlinks= support:

#+BEGIN_EXAMPLE
//192.168.231.1/revit-ballet-runtime /home/user/revit-ballet/runtime cifs username=smb-revit-ballet,password=<password>,uid=1000,gid=1000,mfsymlinks,_netdev,noserverino 0 0
//192.168.231.1/revit-addins /home/user/revit-ballet/deploy cifs username=smb-revit-ballet,password=<password>,uid=1000,gid=1000,mfsymlinks,_netdev,noserverino 0 0
#+END_EXAMPLE

*Critical options:*
- =mfsymlinks= - Enables symlink support on CIFS (required for git worktrees)
- =noserverino= - Avoids inode caching issues on case-insensitive filesystems
- =_netdev= - Waits for network before mounting

** Repository Structure

After mounting, the repository structure:

#+BEGIN_EXAMPLE
/home/user/revit-ballet/
├── deploy/         # Symlink → CIFS mount of Revit Addins folder
├── runtime/        # Symlink → CIFS mount of runtime data folder
├── commands/       # Git-tracked source code
├── installer/      # Git-tracked installer code
└── .worktrees/     # Git worktrees for parallel Claude instances
#+END_EXAMPLE

* Multi-Instance Development with Git Worktrees

** Starting a New Claude Code Instance

SSH into VM and create a new worktree with tmux session:

#+BEGIN_SRC bash
ssh -t user@192.168.231.92 '
  RANDOM_ID=$RANDOM$RANDOM;
  tmux new-session "
    cd /home/user/revit-ballet &&
    git worktree add -b claude2-$RANDOM_ID .worktrees/claude2-$RANDOM_ID &&
    cd .worktrees/claude2-$RANDOM_ID &&
    ln -s ../../deploy &&
    ln -s ../../runtime &&
    ~/.local/bin/claude --dangerously-skip-permissions
  "
'
#+END_SRC

** Why Tmux?

- *Session tracking*: Each Claude instance runs in a named tmux session
- *Reconnection*: Detach/reattach to running Claude sessions
- *Multi-shell*: Easy to open additional shells in the same worktree context
- *Process isolation*: Clean separation between parallel Claude instances

** Worktree Benefits

- Multiple Claude instances work on different branches simultaneously
- Shared =deploy/= and =runtime/= folders via symlinks
- Isolated git state (staging, commits) per instance
- No risk of conflicting file modifications

* Deployment Flow

1. *Build*: Claude modifies code in worktree
2. *Compile*: =dotnet build= outputs to =deploy/= (CIFS mount)
3. *Revit loads*: Windows Revit reads DLLs from Addins folder (shared via SMB)
4. *Live testing*: Changes immediately available in Revit
5. *Runtime data*: Logs, diagnostics, screenshots written to =runtime/= (shared via SMB)

* Network Architecture

#+BEGIN_EXAMPLE
Windows Host (192.168.231.1)
├── Revit instances
├── SMB server (revit-ballet-runtime, revit-addins)
└── Hyper-V Virtual Switch

Debian VMs (192.168.231.x)
├── CIFS mounts → Windows SMB shares
├── Git worktrees with symlinks to mounts
└── Claude Code instances (tmux sessions)
#+END_EXAMPLE

* Filesystem Considerations

See =CLAUDE.md= § "Case-Insensitive Filesystems" for CIFS/git interaction details:
- Filesystem is case-insensitive (Windows behavior)
- Git is case-sensitive (tracks =Foo.cs= and =foo.cs= as different files)
- Use =mfsymlinks= for proper symlink support
- Avoid interactive git operations (rebase -i) on CIFS when possible
